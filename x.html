<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>OpenCV.js Face Detection</title>
    <style>
        #canvasOutput {
            border: 1px solid black;
        }

        /* ------------------------------
   Estilo general muy simple
------------------------------ */
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #acacac;
            color: #000;
            text-align: center;
        }

        h2 {
            margin-bottom: 5px;
            background-color: rgba(250, 235, 215, 0.548);
        }

        #status {
            font-size: 14px;
            margin-bottom: 20px;
        }

        /* ------------------------------
   Contenedores de Input / Output
------------------------------ */

        .inputoutput {
            display: inline-block;
            margin: 10px;
        }

        /* Imagen y canvas con borde negro como en pantalla 2 */
        .inputoutput img,
        .inputoutput canvas {
            border: 1px solid #000;
            width: 320px;
            /* tama√±o consistente */
            height: auto;
        }

        /* Caption simple */
        .caption {
            font-size: 13px;
            margin-top: 5px;
        }

        /* ------------------------------
   Botones minimalistas
------------------------------ */
        button {
            background: #e0e0e0;
            border: 1px solid #000;
            padding: 8px 15px;
            margin: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        button:hover {
            background: #cfcfcf;
        }

        /* ------------------------------
   Video
------------------------------ */
        video {
            border: 1px solid #000;
            margin-top: 20px;
            width: 640px;
            height: 480px;
        }
    </style>
</head>

<body>
    <h2>Face Detection</h2>
    <p id="status">OpenCV.js is loading...</p>
    <video id="videoInput" width="640" height="480" autoplay muted></video>
    <canvas id="canvasOutput" width="640" height="480"></canvas>

    <script async src="opencv.js" type="text/javascript"></script>
    <script type="text/javascript">
        class Utils {
            constructor(errorOutputId) {
                this.createFileFromUrl = (path, url, callback) => {
                    let request = new XMLHttpRequest();
                    request.open('GET', url, true);
                    request.responseType = 'arraybuffer';
                    request.onload = function () {
                        if (request.status === 200 || request.status === 0) {
                            let data = new Uint8Array(request.response);
                            cv.FS_createDataFile('/', path, data, true, false, false);
                            callback();
                        } else {
                            console.error('Failed to load ' + url);
                            document.getElementById(errorOutputId).innerText = 'Failed to load ' + url;
                        }
                    };
                    request.send();
                };
            }
        }

        let streaming = false;
        let video = document.getElementById('videoInput');
        let canvasOutput = document.getElementById('canvasOutput');
        let ctx = canvasOutput.getContext('2d');
        let faceCascade;

        function startFaceDetection() {
            let utils = new Utils('status');
            let faceCascadeFile = 'haarcascade_frontalface_default.xml';
            let faceCascadeUrl = 'https://raw.githubusercontent.com/opencv/opencv/master/data/haarcascades/haarcascade_frontalface_default.xml';

            utils.createFileFromUrl(faceCascadeFile, faceCascadeUrl, () => {
                faceCascade = new cv.CascadeClassifier();
                faceCascade.load(faceCascadeFile);

                navigator.mediaDevices.getUserMedia({ video: true, audio: false })
                    .then(stream => {
                        video.srcObject = stream;
                        video.play();
                        streaming = true;
                        detectFaces();
                    })
                    .catch(err => {
                        console.error(err);
                        document.getElementById('status').innerText = 'Error accessing camera';
                    });
            });
        }

        function detectFaces() {
            if (!streaming) return;
            let cap = new cv.VideoCapture(video);
            let frame = new cv.Mat(video.height, video.width, cv.CV_8UC4);
            let gray = new cv.Mat();

            function processVideo() {
                if (!streaming) {
                    frame.delete(); gray.delete();
                    return;
                }

                cap.read(frame);
                cv.cvtColor(frame, gray, cv.COLOR_RGBA2GRAY);

                let faces = new cv.RectVector();
                let msize = new cv.Size(0, 0);
                faceCascade.detectMultiScale(gray, faces, 1.1, 3, 0, msize, msize);

                ctx.drawImage(video, 0, 0, video.width, video.height);
                for (let i = 0; i < faces.size(); ++i) {
                    let face = faces.get(i);
                    ctx.strokeStyle = 'red';
                    ctx.lineWidth = 3;
                    ctx.strokeRect(face.x, face.y, face.width, face.height);
                }

                faces.delete();
                requestAnimationFrame(processVideo);
            }

            requestAnimationFrame(processVideo);
        }

        var Module = {
            onRuntimeInitialized() {
                document.getElementById('status').innerText = 'OpenCV.js ready for video';
                startFaceDetection();
            }
        };
    </script>
</body>

</html>